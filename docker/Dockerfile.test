# Dockerfile para ambiente de teste de integração
FROM python:3.11-slim

LABEL maintainer="Desafio Técnico - Engenharia de Dados"
LABEL description="Ambiente de testes para SiCooperative Data Lake POC"
LABEL version="1.0.0"


# ============================================================================
# VARIÁVEIS DE AMBIENTE
# ============================================================================
#ENV APP_HOME=/home/sparkuser/app


# ============================================================================
# DIRETÓRIOS DA APLICAÇÃO
# ============================================================================
RUN mkdir -p /app/src /app/output /app/logs /app/config
#RUN mkdir -p $APP_HOME/{src,output,logs,config}

RUN apt-get update && \
    apt-get install -y \
    curl \
    gnupg \
    apt-transport-https \
    && rm -rf /var/lib/apt/lists/*

# Instalar Docker CLI e Docker Compose (para testes de integração)
RUN echo "nameserver 8.8.8.8" > /etc/resolv.conf && \
    apt-get update && \
    curl -fsSL https://download.docker.com/linux/debian/gpg | apt-key add - && \
    echo "deb [arch=amd64] https://download.docker.com/linux/debian $(lsb_release -cs) stable" > /etc/apt/sources.list.d/docker.list && \
    apt-get update && \
    apt-get install -y --no-install-recommends docker-ce-cli && \
    curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose && \
    chmod +x /usr/local/bin/docker-compose && \
    rm -rf /var/lib/apt/lists/*

# Instalar mysql-connector-python para testes
RUN pip install mysql-connector-python pandas pytest

# Criar diretório de trabalho
WORKDIR /app/project

# Copiar requirements para instalação
COPY requirements.txt /app/project/
RUN if [ -f requirements-test.txt ]; then \
        cp requirements-test.txt /app/project/; \
    else \
        echo "# Arquivo de requirements de teste não encontrado" > /app/project/requirements-test.txt; \
    fi

# Instalar dependências Python
RUN pip install -r requirements.txt

# Se existir arquivo de requirements de teste, instalar também
RUN if [ -f requirements-test.txt ]; then pip install -r requirements-test.txt; fi

# Criar usuário não-root para execução de testes
RUN useradd -m testuser && chown -R testuser:testuser /app
USER testuser

# Comando padrão: manter container ativo
CMD ["tail", "-f", "/dev/null"]

# ============================================================================
# Docker Compose - SiCooperative Data Lake POC
# ============================================================================
# Este arquivo orquestra os serviços necessários para o pipeline ETL:
# - MySQL: Banco de dados fonte
# - Spark: Ambiente de processamento distribuído
# ============================================================================

services:
  # ==========================================================================
  # SERVIÇO: MySQL Database
  # ==========================================================================
  mysql:
    image: mysql:8.0.36
    container_name: sicooperative-mysql
    restart: unless-stopped

    # Recursos limitados para otimizacao
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

    # Otimizacoes de performance MySQL
    environment:
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/mysql_root_password
      MYSQL_DATABASE: ${MYSQL_DATABASE:-sicooperative_db}
      MYSQL_USER: ${MYSQL_USER:-etl_user}
      MYSQL_PASSWORD_FILE: /run/secrets/mysql_password
      TZ: America/Sao_Paulo
      # Otimizacoes MySQL para performance
      MYSQL_DEFAULT_AUTHENTICATION_PLUGIN: mysql_native_password

    ports:
      - "${MYSQL_PORT:-3306}:3306"

    volumes:
      # Scripts SQL executados automaticamente na inicializacao
      - ../sql:/docker-entrypoint-initdb.d:ro
      # Persistencia de dados
      - mysql_data:/var/lib/mysql

    networks:
      - sicooperative-network

    # Comando otimizado para performance
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --default-authentication-plugin=mysql_native_password
      --max_connections=200
      --innodb_buffer_pool_size=256M
      --innodb_log_file_size=64M
      --query_cache_size=0
      --query_cache_type=0

    secrets:
      - mysql_root_password
      - mysql_password

    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "--password=$$(cat /run/secrets/mysql_root_password)"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 180s

  # ==========================================================================
  # SERVIÇO: Spark (PySpark)
  # ==========================================================================
  spark:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: sicooperative-spark
    restart: unless-stopped

    # Recursos limitados para otimizacao
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

    environment:
      # Configurações Spark
      SPARK_APP_NAME: SiCooperative-ETL
      SPARK_MASTER: local[*]
      SPARK_DRIVER_MEMORY: 2g
      SPARK_EXECUTOR_MEMORY: 2g

      # Otimizacoes MySQL para performance
      MYSQL_DEFAULT_AUTHENTICATION_PLUGIN: mysql_native_password

      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/mysql_root_password
      MYSQL_DATABASE: ${MYSQL_DATABASE:-sicooperative_db}
      MYSQL_USER: ${MYSQL_USER:-etl_user}
      MYSQL_PASSWORD_FILE: /run/secrets/mysql_password

      # Configurações de Output
      OUTPUT_DIR: /app/output
      OUTPUT_FILENAME: movimento_flat.csv
      OUTPUT_MODE: overwrite
      OUTPUT_HEADER: "true"
      
      # Configurações de Log
      LOG_LEVEL: INFO
      
      # Timezone
      TZ: America/Sao_Paulo

    volumes:
      # Código fonte
      - ../src:/app/src:ro
      # Output (leitura/escrita)
      - ../output:/app/output
      # Requirements (para instalação)
      - ../requirements.txt:/app/requirements.txt:ro

    networks:
      - sicooperative-network

    secrets:
      - mysql_root_password
      - mysql_password
    
    working_dir: /app
        
    depends_on:
      mysql:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "python", "-c", "import pyspark; print('Spark OK')"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 180s
    
  # ==========================================================================
  # SERVIÇO: Ambiente de Teste
  # ==========================================================================
  test:
    build:
      context: ..
      dockerfile: docker/Dockerfile.test
    container_name: sicooperative-test
    restart: "no"

    # Recursos para testes
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'  # Não reiniciar automaticamente

    environment:
      # Configurações MySQL (teste)
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_DATABASE: sicooperative_test
      MYSQL_USER: test_user
      MYSQL_PASSWORD: test_password

      # Configurações de Output (teste)
      OUTPUT_DIR: /app/test_output

      # Configurações de Log (teste)
      LOG_LEVEL: INFO

      # Timezone
      TZ: America/Sao_Paulo

    volumes:
      # Código fonte (leitura/escrita para testes)
      - ..:/app/project:ro
      # Scripts de teste
      - ../tests:/app/tests:ro
      # Output de teste
      - ../test_output:/app/test_output

    working_dir: /app/project

    networks:
      - sicooperative-network

    depends_on:
      mysql:
        condition: service_healthy

    # Comando: manter container ativo para execução manual de testes
    command: tail -f /dev/null

# ============================================================================
# SECRETS (Docker Secrets)
# ============================================================================
# IMPORTANTE: Crie arquivos de secrets antes de executar docker-compose
# Comando: echo "sua_senha_segura" > secrets/mysql_root_password
# Comando: echo "sua_senha_segura" > secrets/mysql_password
# ============================================================================
secrets:
  mysql_root_password:
    file: ./secrets/mysql_root_password
  mysql_password:
    file: ./secrets/mysql_password

# ============================================================================
# NETWORKS
# ============================================================================
networks:
  sicooperative-network:
    driver: bridge
    name: sicooperative-network

# ============================================================================
# VOLUMES
# ============================================================================
volumes:
  mysql_data:
    name: sicooperative-mysql-data
    driver: local
